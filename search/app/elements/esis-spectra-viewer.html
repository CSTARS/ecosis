<dom-module id="esis-spectra-viewer">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <h5>
      Spectra #&nbsp;
      <select on-change="updateFromSelect" id="selectSpectraInput" style="min-width:100px"></select>
      &nbsp;of <span id="totalSpectraLabel"></span>
    </h5>

    <div style="position:relative">
        <div id="root" style="height: 450px"></div>
        <span class="label label-success" id="loadingPanel">
          <i class="fa fa-spinner fa-spin"></i> Loading #<span id="selectedIndexLabel"></span>...
        </span>
    </div>

    <div class="well">
      <div class="row" style="margin-top: 10px">
        <div class="col-sm-2">Add Filter</div>
        <div class="col-sm-10"><select id="spectraFilterSelector"></select></div>
      </div>

      <div class="row" style="margin-top: 10px">
        <div class="col-sm-2">Current Filters</div>
        <div class="col-sm-10" id="filterBtnsPanel"></div>
      </div>

      <div class="row" style="margin-top: 10px">
        <div class="col-sm-2">Wavelength Range</div>
        <div class="col-sm-10" id="sliderRoot">

        </div>
      </div>

      <div class="row">
        <div class="col-md-3"><a on-click="toggleAdvanced"><i class="fa fa-cogs"></i> Advanced</a></div>
        <div class="col-md-9">

          <div class="advanced" id="advancedPanel" style="display:none">
              <h4>Compare Spectra</h4>
              <table class="table">
                  <tr>
                      <td>
                          <a class="btn btn-default" on-click="startCompareAdd">
                            <i class="fa fa-plus"></i> Add to Compare List
                          </a>

                          <div id="addingComparePanel" class="addLabel">
                              Specta Label: <input type="text" value="compareLabel" />
                              <a class="btn btn-default" on-click="addCompare" ><i class="fa fa-plus"></i> Add</a>
                              <a class="btn btn-default" on-click="cancelAddCompare" >Cancel</a>
                          </div>
                      </td>
                      <td align="right">
                          <input type="checkbox" id="compareInput"/> Show Compare Spectra
                      </td>
                  </tr>
                  <tr id="compareRow">
                      <td colspan="2">
                          <h6>Comparing:</h6>
                          <div id="comparingBtnList"></div>
                      </td>
                  </tr>
              </table>

              <h4 style="margin-top:40px">Set Wavelength Range</h4>
              <table class="table">
                  <tr>
                      <td>Min Wavelength (<span id="minWavelengthLabel"></span>)</td>
                      <td>
                          <input id="minWavelength" type="number" on-change="setMinWavelength" />
                      </td>
                  </tr>
                   <tr>
                      <td>Max Wavelength (<span id="maxWavelengthLabel"></span>)</td>
                      <td>
                          <input id="maxWavelength" type="number" on-change="setMaxWavelength" />
                      </td>
                  </tr>
              </table>


          </div>

        </div>
      </div>

      <div style="margin-top: 10px">
        <a class="btn btn-default" on-click="print"><i class="fa fa-print"></i> Printable Chart</a>
        <a class="btn btn-default" id="restLink" target="_blank"><i class="fa fa-link"></i> Developer Rest Link</a>
      </dvi>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'esis-spectra-viewer',

    properties : {
      package : {
        type: String
      },
      total : {
        type : String
      }
    },

    attached : function() {
        $(window).on('resize', function(){
            this.redraw();
        }.bind(this));

        this.item = {};
        this.ptRegex1 = /^-?\d+\.?\d*$/;
        this.ptRegex2 = /^-?\d*\.\d+$/;

        this.ignoreList = ['_id', 'datapoints', 'ecosis'];
    },

    setOnloadHandler : function() {
        if( this.onLoadHandlerSet ) return;

        // in global scope
        chartLoadHandlers.push(this.update.bind(this));
    },

    print : function() {
        window.open(this.chart.getImageURI());
    },

    update : function() {
        if( !window.google.visualization ) return this.setOnloadHandler();
        if( !window.google.visualization.LineChart ) return this.setOnloadHandler();

        if( !this.chart ) {
            this.chart = new google.visualization.LineChart(this.$.root);
        }

        this.indexes = [];
        this.selectedIndex = 0;
        this.totalSpectra = parseInt(this.total);

        this.dsFilters = [''];
        for( var key in this.item ) {
            if( this.ignoreList.indexOf(key) > -1 ) continue;
            this.dsFilters.push(key);
        }

        this.filters = [];


        this.updateDataTable(true);
    },

    updateFilterValues : function() {
        this.dsFilterValues = [''];
        var attr = this.item[this.dsFilter];
        if( !attr ) return;

        for( var i = 0; i < attr.length; i++ ) {
            this.dsFilterValues.push(attr[i]);
        }
    },

    addDsFilter : function() {
        this.async(function(){
            if( this.dsFilterValue == '' ) return;

            this.addFilter(this.dsFilter, this.dsFilterValue, true);
            this.dsFilter = '';
        });
    },

    updateFromSelect : function(e) {
      this.selectedIndex = parseInt(e.currentTarget.value);
      this.updateDataTable(false);
    },

    compareUpdated : function() {
        if( this.showCompare ) {
            this.updateDataTable(false);
        }
    },

    updateDataTable : function(resetWavelengths) {
        this.$.loadingPanel.style.display = 'inline-block';

        var filters = '';
        var fArray = [];
        for( var i = 0; i < this.filters.length; i++ ) {
            var obj = {};
            obj[this.filters[i].key] = this.filters[i].value;
            fArray.push(obj);
        }

        if( this.filters.length > 0 ) {
            filters = '&filters='+encodeURIComponent(JSON.stringify(fArray));
        }

        var url = '/rest/getSpectra?package_id='+this.package+filters+'&index='+this.selectedIndex;

        if( this.xhr != null ) this.xhr.abort();

        this.xhr = $.ajax({
            url : url,
            success : function(resp) {
              this.$.loadingPanel.style.display = 'none';
              this.xhr = null;

              this.totalSpectra = resp.total;
              this.item = resp.item;
              this.createTableArray(resetWavelengths);
              this.updateIndexSelector();
              this.updateFilters();
            }.bind(this)
        });

        this.$.restLink.setAttribute('href', window.location.origin+url);
    },

    updateIndexSelector : function() {
      var options = '';
      for( var i = 0; i < this.totalSpectra; i++ ) {
        options += '<option value="'+i+'" '+(i == this.selectedIndex ? 'selected' : '')+'>'+i+'</option>';
      }
      this.$.selectSpectraInput.innerHTML = options;

      this.$.totalSpectraLabel.innerText = this.totalSpectra;

      this.$.sliderRoot.innerHTML = '<div><input type="text" style="width:100%" value="" data-with="100%" data-slider-min="10" data-slider-max="2000" data-slider-step="1" data-slider-value="[250,450]" id="slider" /></div>';
      setTimeout(function(){
        $(this.$.sliderRoot).find('#slider').slider({});
        $(this.$.sliderRoot).find('.slider').width('100%');
      }.bind(this), 500);

    },

    updateFilters : function() {
      var filterBtns = '<option></option>';
      for( var key in this.item ) {
        if( key == 'ecosis' || key == '_id' || key == 'datapoints' ) continue;
        filterBtns += '<option key="'+key+'" value="'+this.item[key]+'">'+key+': '+this.item[key]+'</option>';
      }

      this.$.spectraFilterSelector.innerHTML = filterBtns;
    },

    createTableArray : function(resetWavelengths) {
        if( typeof resetWavelengths == 'object' ) resetWavelengths = false;

        this.metadata = [];
        this.indexes = [];
        this.wavelengths = [];

        for( var i = 0; i < this.totalSpectra; i++ ) this.indexes.push(i);

        this.dataArray = [];
        var wavelengthHash = {}, hasCurrent = false;

        if( this.totalSpectra == 0 ) return;

        if( this.showCompare ) {
            var i;
            for( i = 0; i < this.compareList.length; i++ ) {
                this.addToDataArray(this.compareList[i].spectra, wavelengthHash, i);
                if( this.compareList[i].spectra._id == this.resp._id ) hasCurrent = true;
            }

            if( !hasCurrent ) {
                this.addToDataArray(this.resp, wavelengthHash, i);
            }

            for( var key in wavelengthHash ) {
                this.dataArray.push( wavelengthHash[key] );
            }

        } else {
            for( var i = 0; i < this.item.datapoints.length; i++ ) {
                pt = this.item.datapoints[i];
                if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                    this.dataArray.push([parseFloat(pt.key), parseFloat(pt.value)]);
                } else {
                    this.metadata.push(pt);
                }
            }
        }


        for( var key in this.resp ) {
            if( this.ignoreList.indexOf(key) == -1 && typeof this.resp[key] == 'string' && this.resp[key] != '' ) {
                this.metadata.push({
                    key : key,
                    value : this.resp[key],
                    class : this._getMetadataClass(key, this.resp[key])
                })
            }
        }

        this.dataArray.sort(function(a, b){
            if( a[0] < b[0] ) return -1;
            if( a[0] > b[0] ) return 1;
            return 0;
        });

        for( var i = 0; i < this.dataArray.length; i++ ) {
            this.wavelengths.push(this.dataArray[i][0]);
        }

        if( resetWavelengths ) {
            this.setWavelength('min', this.wavelengths[0]);
            this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
        } else {
            if( this.minWavelength < this.wavelengths[0] ) {
                this.setWavelength('min', this.wavelengths[0]);
            }
            if( this.maxWavelength > this.wavelengths[this.wavelengths.length-1] ) {
                this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
            }
        }

        if( this.showCompare ) {
            var header = ['Wavelength'];
            for( var i = 0; i < this.compareList.length; i++ ) {
                if( this.compareList[i].spectra._id == this.resp._id ) {
                    header.push(this.compareList[i].name+' (Current)');
                } else {
                    header.push(this.compareList[i].name);
                }
            }
            if( !hasCurrent ) {
                header.push('Current');
            }
            this.dataArray.splice(0,0,header);
        } else {
            this.dataArray.splice(0,0,['Wavelength','Reflectance']);
        }


        this.filterByWavelength();
        this.loading = false;
    },

    addToDataArray : function(spectra, wavelengthHash, i) {
        var cWaves = [], pt;
        for( var j = 0; j < spectra.datapoints.length; j++ ) {
            pt = spectra.datapoints[j];

            if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                if( wavelengthHash[pt.key] !== undefined ) {
                    wavelengthHash[pt.key].push(parseFloat(pt.value));
                } else {
                    wavelengthHash[pt.key] = [parseFloat(pt.key)];
                    for( var z = 0; z < i; z++ ) wavelengthHash[pt.key].push(null);
                    wavelengthHash[pt.key].push(parseFloat(pt.value));
                }
                cWaves.push(pt.key);
            }
        }

        // add any waves this one is missing
        for( var key in wavelengthHash ) {
            if( cWaves.indexOf(key) > -1 ) continue;
            wavelengthHash[key].push(null);
        }
    },

    setWavelength : function(type, value) {
        this.$[type+'Wavelength'].value = value;
        this[type+'Wavelength'] = value;
    },

    setMinWavelength : function() {
        this.minWavelength = parseFloat(this.$.minWavelength.value);
        if( this.minWavelength < this.wavelengths[0] ) {
            this.setWavelength('min', this.wavelengths[0]);
        } else if ( this.minWavelength > this.maxWavelength ) {
            this.setWavelength('min', this.maxWavelength);
        }
        this.filterByWavelength();
    },

    setMaxWavelength : function() {
        this.maxWavelength = parseFloat(this.$.maxWavelength.value);
        if( this.maxWavelength >= this.wavelengths[this.wavelengths.length-1] ) {
            this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
        } else if ( this.minWavelength > this.maxWavelength ) {
            this.setWavelength('max', this.minWavelength);
        }
        this.filterByWavelength();
    },

    filterByWavelength : function() {
        var arr = [this.dataArray[0]];
        for( var i = 1; i < this.dataArray.length; i++ ) {
            if( this.dataArray[i][0] >= this.minWavelength &&
                this.dataArray[i][0] <= this.maxWavelength ) {

                var clone = this.dataArray[i].slice(0);
                clone[0] = clone[0]+'';
                arr.push(clone);
            }
        }

        this.dt = google.visualization.arrayToDataTable(arr);
        this.redraw();
    },

    redraw : function() {
        if( !this.chart || !this.dt ) return;

        var options = {
            legend : {
                position : 'none'
            },
            vAxis : {},
            hAxis : {}
        };

        if( this.label && this.label != '' ) {
            options.title = this.label;
        }
        if( this.xlabel && this.xlabel != '' ) {
            options.hAxis.title = this.xlabel;
        }
        if( this.ylabel && this.ylabel != '' ) {
            options.vAxis.title = this.ylabel;
        }

        options.animation = {
            duration : 750,
            easing : 'out'
        }

        this.chart.draw(this.dt, options);
    },

    removeFilter : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('filterIndex'));
        this.removeFilter(index, 1, true);
    },

    addFilterFromBtn : function(e) {
        this.addFilter(e.currentTarget.getAttribute('filterKey'), e.currentTarget.getAttribute('filterValue'), true);
    },

    getMetadataClass : function(key, value) {
        for( var i = 0; i < this.filters.length; i++ ) {
            if( this.filters[i].key == key && this.filters[i].value == value ) {
                return 'selected';
            }
        }
        return '';
    },

    removeFilter : function(index, update) {
        var item = this.filters.splice(index, 1)[0];

        for( var i = 0; i < this.metadata.length; i++ ) {
            if( this.metadata[i].key == item.key && this.metadata[i].value == item.value ) {
                this.metadata[i].class = '';
                break;
            }
        }

        if( update ) {
            this.selectedIndex = 0;
            this._updateDataTable();
        }
    },

    addFilter : function(key, value, update) {
        for( var i = 0; i < this.filters.length; i++ ) {
            if( this.filters[i].key == key ) {
                this.removeFilter(i);
                break;
            }
        }

        for( var i = 0; i < this.metadata.length; i++ ) {
            if( this.metadata[i].key == key && this.metadata[i].value == value ) {
                this.metadata[i].class = 'selected';
                break;
            }
        }

        this.filters.push({
            key : key,
            value : value
        });

        if( update ) {
            this.selectedIndex = 0;
            this._updateDataTable(false);
        }
    },

    toggleAdvanced : function() {
      $(this.$.advancedPanel).toggle();
    },

    startCompareAdd : function() {
        if( this.compareList.length >= 10 ) {
            return alert('You can only compare up to 10 spectra a one time.  Please remove one spectra then retry.');
        }

        for( var i = 0; i < this.compareList.length; i++ ) {
            if( this.compareList[i].spectra._id == this.resp._id ) {
                return alert('This spectra is already in your compare list');
            }
        }

        this.addingCompare = true;
        this.compareLabel = this.getLabel(this.item.ecosis.package_title, 0);
    },

    removeCompare : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('index'));
        this.compareList.splice(index, 1);
    },

    cancelAddCompare : function() {
        this.addingCompare = false;
    },

    addCompare : function() {
        this.compareList.push({
            name : this.compareLabel,
            spectra : this.resp
        });

        this.addingCompare = false;
        this.showCompare = true;
    },

    getLabel : function(label, index) {
        var l = (index == 0) ? label : label+' - '+index;
        for( var i = 0; i < this.compareList.length; i++ ) {
            if( this.compareList[i].name == l ) {
                index++;
                return this.getLabel(label, index);
            }
        }
        return l;
    }

  });
</script>


<!--
<polymer-element name="esis-spectra-viewer" attributes="package item spectra_count">
    <template>
        <style>
            :host {
                display: block;
            }
            .metadata {
                max-height: 250px;
                overflow: auto;
                margin-left: 50px;
            }

            .metadata div {
                margin: 7px;
                padding: 10px;
                box-shadow: 0 0 5px #888;
                display: inline-block;
                cursor: pointer;
            }
            .selected {
                border: 2px solid #888;
                background-color: #eee;
                margin: -2px;
            }
            .loading {
                position: absolute;
                top: 15px;
                left: 15px;
                font-size: 18px;
                color: #333;
            }
            paper-slider  {
                width : 100%;
            }
            .advanced {
                padding: 10px;
                box-shadow: 0 0 5px #888 inset;
                margin: 0px 10px 25px 20px;
            }
            esis-icon {
                color: #428bca;
            }
            .addLabel {
                padding: 5px;
                margin: 2px;
                background: #eee;
                border-radius: 6px;
            }
        </style>

        <core-localstorage name="esis_compare" value="{{compareList}}"></core-localstorage>

        <div layout horizontal>
            <div hidden?="{{filters.length == 0}}">
                Filters:&nbsp;&nbsp;
            </div>
            <div flex>
                <template repeat="{{filter, i in filters}}">
                    <a class="btn btn-default" filterIndex="{{i}}" on-click="{{removeFilter}}" title="Remove Filter"><esis-icon icon="fa-remove"></esis-icon> <span style="color:#888">{{filter.key}}:</span> <b>{{filter.value}}</b></a>
                </template>
            </div>
        </div>

        <div style="position:relative">
            <div id="root" style="height: 450px"></div>
            <div class="loading" hidden?="{{!loading}}">
                Loading #{{selectedIndex}}...
            </div>
        </div>

        <div>
            <div>
                <a class="btn btn-link" on-tap="{{toggleAdvanced}}"><esis-icon icon="fa-cogs"></esis-icon> Advanced</a>
            </div>
            <div class="advanced" hidden?="{{!showAdvanced}}">
                <h4>Compare Spectra</h4>
                <table class="table">
                    <tr>
                        <td>
                            <a class="btn btn-default" on-tap="{{startCompareAdd}}"><esis-icon icon="fa-plus"></esis-icon> Add to Compare List</a>
                            <div hidden?="{{!addingCompare}}" class="addLabel">
                                Specta Label: <input type="text" value="{{compareLabel}}" />
                                <a class="btn btn-default" on-tap="{{addCompare}}" ><esis-icon icon="fa-plus"></esis-icon> Add</a>
                                <a class="btn btn-default" on-tap="{{cancelAddCompare}}" >Cancel</a>
                            </div>
                        </td>
                        <td align="right">
                            <input type="checkbox" checked="{{showCompare}}"/> Show Compare Spectra
                        </td>
                    </tr>
                    <tr hidden?="{{!showCompare}}">
                        <td colspan="2">
                            <h6>Comparing:</h6>
                            <template repeat="{{spectra, i in compareList}}">
                                <a class="btn btn-default" index="{{i}}" on-tap="{{removeCompare}}"><esis-icon icon="fa-remove"></esis-icon> {{spectra.name}}</a>
                            </template>
                        </td>
                    </tr>
                </table>



                <h4 style="margin-top:40px">Set Wavelength Range</h4>
                <table class="table">
                    <tr>
                        <td>Min Wavelength ({{wavelengths[0]}})</td>
                        <td>
                            <input id="minWavelength" type="number" on-change="{{setMinWavelength}}" />
                        </td>
                    </tr>
                     <tr>
                        <td>Max Wavelength ({{wavelengths[wavelengths.length-1]}})</td>
                        <td>
                            <input id="maxWavelength" type="number" on-change="{{setMaxWavelength}}" />
                        </td>
                    </tr>
                </table>

                <h4 style="margin-top:40px">Add Filter from Dataset</h4>
                <table class="table">
                    <tr>
                        <td>Attribute</td>
                        <td>
                            <select value="{{dsFilter}}">
                                <template repeat="{{attr in dsFilters}}">
                                    <option value="{{attr}}">{{attr}}</option>
                                </template>
                            </select>
                        </td>
                    <tr hidden?="{{dsFilter == ''}}">
                        <td>Value</td>
                        <td>
                            <select value="{{dsFilterValue}}" on-change="{{addDsFilter}}">
                                <template repeat="{{val in dsFilterValues}}">
                                    <option value="{{val}}">{{val}}</option>
                                </template>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div layout horizontal>
            <div>
                <div style="margin-bottom: 15px">
                    Spectra #
                    <select value="{{selectedIndex}}" on-change="{{_updateFromSelect}}">
                        <template repeat="{{index in indexes}}">
                            <option value="{{index}}">{{index}}</option>
                        </template>
                    </select>
                    of {{totalSpectra}}
                </div>
                <div style="margin-bottom: 15px">
                    <a class="btn btn-default" on-tap="{{print}}"><esis-icon icon="fa-print"></esis-icon> Printable Chart</a>
                </div>
                <div>
                    <a class="btn btn-default" href="{{rest}}" target="_blank"><esis-icon icon="fa-link"></esis-icon> Developer Rest Link</a>
                </div>
            </div>
            <div flex>
                <div class="metadata" hidden?="{{metadata.length == 0 }}">
                    <h4>Filter Dataset</h4>
                    <template repeat="{{m in metadata}}">
                        <div class="{{m.class}}" filterKey="{{m.key}}" filterValue="{{m.value}}" on-click="{{addFilterFromBtn}}" title="Add Filter">
                            <esis-icon icon="fa-plus-circle" hidden?="{{m.class == 'selected'}}"></esis-icon>
                            <span style="color:#888">{{m.key}}:</span> <b>{{m.value}}</b>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </template>
    <script>
        Polymer('esis-spectra-viewer', {
            dt : null,
            dataArray : [],
            chart : null,
            loading: false,

            showAdvanced : false,

            rest : '',

            ptRegex1 : /^-?\d+\.?\d*$/,
            ptRegex2 : /^-?\d*\.\d+$/,

            showCompare : false,
            addingCompare : false,
            compareLabel : false,
            compareList : [],

            dsFilter : '',
            dsFilters : [],
            dsFilterValue : '',
            dsFilterValues : [],

            selectedIndex : 0,
            totalSpectra : 0,
            indexes : [],
            metadata : [],

            filters : [],

            ignoreList : ['_id', 'datapoints', 'ecosis'],

            onLoadHandlerSet : false,

            wavelengths : [],
            maxWavelength : 0,
            minWavelength : 0,

            resp : null,
            xhr : null,

            observe : {
                filters : '_fireUpdate',
                package : '_update',
                dsFilter : '_updateFilterValues',
                compareList : '_compareUpdated',
                showCompare : '_createTableArray'
            },

            ready : function() {
                $(window).on('resize', function(){
                    this.redraw();
                }.bind(this));
            },

            setOnloadHandler : function() {
                if( this.onLoadHandlerSet ) return;

                console.log('callback set');

                // put in global scope by cwn-datastore
                chartLoadHandlers.push(function(){
                    this._update();
                }.bind(this));
            },

            print : function() {
                window.open(this.chart.getImageURI());
            },

            _fireUpdate : function() {
                this.fire('filters-updated', this.filters);
            },

            _update : function() {
                if( !window.google.visualization ) return this.setOnloadHandler();
                if( !window.google.visualization.LineChart ) return this.setOnloadHandler();

                if( !this.chart ) {
                    this.chart = new google.visualization.LineChart(this.$.root);
                }

                this.indexes = [];
                this.selectedIndex = 0;
                this.totalSpectra = this.spectra_count;

                this.dsFilters = [''];
                for( var key in this.item ) {
                    if( this.ignoreList.indexOf(key) > -1 ) continue;
                    this.dsFilters.push(key);
                }

                // if there is a group_by attribute, set as default filter
                this.filters = [];
                if( this.item.ecosis.group_by && this.item.ecosis.group_by != '' ) {
                    this._addFilter(this.item.ecosis.group_by, this.item[this.item.ecosis.group_by][0]);
                }

                this._updateDataTable(true);
            },

            _updateFilterValues : function() {
                this.dsFilterValues = [''];
                var attr = this.item[this.dsFilter];
                if( !attr ) return;

                for( var i = 0; i < attr.length; i++ ) {
                    this.dsFilterValues.push(attr[i]);
                }
            },

            addDsFilter : function() {
                this.async(function(){
                    if( this.dsFilterValue == '' ) return;

                    this._addFilter(this.dsFilter, this.dsFilterValue, true);
                    this.dsFilter = '';
                });
            },

            _updateFromSelect : function() {
                this._updateDataTable(false);
            },

            _compareUpdated : function() {
                if( this.showCompare ) {
                    this._updateDataTable(false);
                }
            },

            _updateDataTable : function(resetWavelengths) {
                this.loading = true;

                var filters = '';
                var fArray = [];
                for( var i = 0; i < this.filters.length; i++ ) {
                    var obj = {};
                    obj[this.filters[i].key] = this.filters[i].value;
                    fArray.push(obj);
                }
                if( this.filters.length > 0 ) {
                    filters = '&filters='+encodeURIComponent(JSON.stringify(fArray));
                }

                var url = '/rest/getSpectra?package_id='+this.package.id+filters+'&index='+this.selectedIndex;

                if( this.xhr != null ) this.xhr.abort();

                this.xhr = $.ajax({
                    url : url,
                    success : function(resp) {
                        this.xhr = null;

                        this.totalSpectra = resp.total;
                        this.resp = resp.item;
                        this._createTableArray(resetWavelengths);
                    }.bind(this)
                });

                this.rest = window.location.origin+url;
            },

            _createTableArray : function(resetWavelengths) {
                if( typeof resetWavelengths == 'object' ) resetWavelengths = false;



                this.metadata = [];
                this.indexes = [];
                this.wavelengths = [];

                for( var i = 0; i < this.totalSpectra; i++ ) this.indexes.push(i);

                this.dataArray = [];
                var wavelengthHash = {}, hasCurrent = false;

                if( this.totalSpectra == 0 ) return;

                if( this.showCompare ) {
                    var i;
                    for( i = 0; i < this.compareList.length; i++ ) {
                        this._addToDataArray(this.compareList[i].spectra, wavelengthHash, i);
                        if( this.compareList[i].spectra._id == this.resp._id ) hasCurrent = true;
                    }
                    if( !hasCurrent ) {
                        this._addToDataArray(this.resp, wavelengthHash, i);
                    }

                    for( var key in wavelengthHash ) {
                        this.dataArray.push( wavelengthHash[key] );
                    }

                } else {
                    for( var i = 0; i < this.resp.datapoints.length; i++ ) {
                        pt = this.resp.datapoints[i];
                        if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                            this.dataArray.push([parseFloat(pt.key), parseFloat(pt.value)]);
                        } else {
                            this.metadata.push(pt);
                        }
                    }
                }


                for( var key in this.resp ) {
                    if( this.ignoreList.indexOf(key) == -1 && typeof this.resp[key] == 'string' && this.resp[key] != '' ) {
                        this.metadata.push({
                            key : key,
                            value : this.resp[key],
                            class : this._getMetadataClass(key, this.resp[key])
                        })
                    }
                }

                this.dataArray.sort(function(a, b){
                    if( a[0] < b[0] ) return -1;
                    if( a[0] > b[0] ) return 1;
                    return 0;
                });
                for( var i = 0; i < this.dataArray.length; i++ ) {
                    this.wavelengths.push(this.dataArray[i][0]);
                }

                if( resetWavelengths ) {
                    this.setWavelength('min', this.wavelengths[0]);
                    this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                } else {
                    if( this.minWavelength < this.wavelengths[0] ) {
                        this.setWavelength('min', this.wavelengths[0]);
                    }
                    if( this.maxWavelength > this.wavelengths[this.wavelengths.length-1] ) {
                        this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                    }
                }

                if( this.showCompare ) {
                    var header = ['Wavelength'];
                    for( var i = 0; i < this.compareList.length; i++ ) {
                        if( this.compareList[i].spectra._id == this.resp._id ) {
                            header.push(this.compareList[i].name+' (Current)');
                        } else {
                            header.push(this.compareList[i].name);
                        }
                    }
                    if( !hasCurrent ) {
                        header.push('Current');
                    }
                    this.dataArray.splice(0,0,header);
                } else {
                    this.dataArray.splice(0,0,['Wavelength','Reflectance']);
                }


                this.filterByWavelength();
                this.loading = false;
            },

            _addToDataArray : function(spectra, wavelengthHash, i) {
                var cWaves = [], pt;
                for( var j = 0; j < spectra.datapoints.length; j++ ) {
                    pt = spectra.datapoints[j];

                    if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                        if( wavelengthHash[pt.key] !== undefined ) {
                            wavelengthHash[pt.key].push(parseFloat(pt.value));
                        } else {
                            wavelengthHash[pt.key] = [parseFloat(pt.key)];
                            for( var z = 0; z < i; z++ ) wavelengthHash[pt.key].push(null);
                            wavelengthHash[pt.key].push(parseFloat(pt.value));
                        }
                        cWaves.push(pt.key);
                    }
                }

                // add any waves this one is missing
                for( var key in wavelengthHash ) {
                    if( cWaves.indexOf(key) > -1 ) continue;
                    wavelengthHash[key].push(null);
                }
            },

            setWavelength : function(type, value) {
                this.$[type+'Wavelength'].value = value;
                this[type+'Wavelength'] = value;
            },

            setMinWavelength : function() {
                this.minWavelength = parseFloat(this.$.minWavelength.value);
                if( this.minWavelength < this.wavelengths[0] ) {
                    this.setWavelength('min', this.wavelengths[0]);
                } else if ( this.minWavelength > this.maxWavelength ) {
                    this.setWavelength('min', this.maxWavelength);
                }
                this.filterByWavelength();
            },

            setMaxWavelength : function() {
                this.maxWavelength = parseFloat(this.$.maxWavelength.value);
                if( this.maxWavelength >= this.wavelengths[this.wavelengths.length-1] ) {
                    this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                } else if ( this.minWavelength > this.maxWavelength ) {
                    this.setWavelength('max', this.minWavelength);
                }
                this.filterByWavelength();
            },

            filterByWavelength : function() {
                var arr = [this.dataArray[0]];
                for( var i = 1; i < this.dataArray.length; i++ ) {
                    if( this.dataArray[i][0] >= this.minWavelength &&
                        this.dataArray[i][0] <= this.maxWavelength ) {

                        var clone = this.dataArray[i].slice(0);
                        clone[0] = clone[0]+'';
                        arr.push(clone);
                    }
                }

                this.dt = google.visualization.arrayToDataTable(arr);
                this.redraw();
            },

            redraw : function() {
                if( !this.chart || !this.dt ) return;

                var options = {
                    legend : {
                        position : 'none'
                    },
                    vAxis : {},
                    hAxis : {}
                };

                if( this.label && this.label != '' ) {
                    options.title = this.label;
                }
                if( this.xlabel && this.xlabel != '' ) {
                    options.hAxis.title = this.xlabel;
                }
                if( this.ylabel && this.ylabel != '' ) {
                    options.vAxis.title = this.ylabel;
                }

                 options.animation = {
                        duration : 750,
                        easing : 'out'
                    }

                this.chart.draw(this.dt, options);
            },

            removeFilter : function(e) {
                var index = parseInt(e.currentTarget.getAttribute('filterIndex'));
                this._removeFilter(index, 1, true);
            },

            addFilterFromBtn : function(e) {
                this._addFilter(e.currentTarget.getAttribute('filterKey'), e.currentTarget.getAttribute('filterValue'), true);
            },

            _getMetadataClass : function(key, value) {
                for( var i = 0; i < this.filters.length; i++ ) {
                    if( this.filters[i].key == key && this.filters[i].value == value ) {
                        return 'selected';
                    }
                }
                return '';
            },

            _removeFilter : function(index, update) {
                var item = this.filters.splice(index, 1)[0];

                for( var i = 0; i < this.metadata.length; i++ ) {
                    if( this.metadata[i].key == item.key && this.metadata[i].value == item.value ) {
                        this.metadata[i].class = '';
                        break;
                    }
                }

                if( update ) {
                    this.selectedIndex = 0;
                    this._updateDataTable();
                }
            },

            _addFilter : function(key, value, update) {
                for( var i = 0; i < this.filters.length; i++ ) {
                    if( this.filters[i].key == key ) {
                        _removeFilter(i);
                        break;
                    }
                }

                for( var i = 0; i < this.metadata.length; i++ ) {
                    if( this.metadata[i].key == key && this.metadata[i].value == value ) {
                        this.metadata[i].class = 'selected';
                        break;
                    }
                }

                this.filters.push({
                    key : key,
                    value : value
                });
                if( update ) {
                    this.selectedIndex = 0;
                    this._updateDataTable(false);
                }
            },

            toggleAdvanced : function() {
                this.showAdvanced = !this.showAdvanced;
            },

            startCompareAdd : function() {
                if( this.compareList.length >= 10 ) {
                    return alert('You can only compare up to 10 spectra a one time.  Please remove one spectra then retry.');
                }

                for( var i = 0; i < this.compareList.length; i++ ) {
                    if( this.compareList[i].spectra._id == this.resp._id ) {
                        return alert('This spectra is already in your compare list');
                    }
                }

                this.addingCompare = true;
                this.compareLabel = this._getLabel(this.item.ecosis.package_title, 0);
            },

            removeCompare : function(e) {
                var index = parseInt(e.currentTarget.getAttribute('index'));
                this.compareList.splice(index, 1);
            },

            cancelAddCompare : function() {
                this.addingCompare = false;
            },

            addCompare : function() {
                this.compareList.push({
                    name : this.compareLabel,
                    spectra : this.resp
                });
                this.addingCompare = false;
                this.showCompare = true;
            },

            _getLabel : function(label, index) {
                var l = (index == 0) ? label : label+' - '+index;
                for( var i = 0; i < this.compareList.length; i++ ) {
                    if( this.compareList[i].name == l ) {
                        index++;
                        return this._getLabel(label, index);
                    }
                }
                return l;
            }

        });
    </script>
</polymer-element>
-->
