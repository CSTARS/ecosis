    <polymer-element name="esis-spectra-viewer" attributes="package item spectra_count">
    <template>
        <style>
            :host {
                display: block;
            }
            .metadata {
                max-height: 250px;
                overflow: auto;
                margin-left: 50px;
            }

            .metadata div {
                margin: 7px;
                padding: 10px;
                box-shadow: 0 0 5px #888; 
                display: inline-block;
                cursor: pointer;
            }
            .selected {
                border: 2px solid #888;
                background-color: #eee;
                margin: -2px;
            }
            .loading {
                position: absolute;
                top: 15px;
                left: 15px;
                font-size: 18px;
                color: #333;
            }
            paper-slider  {
                width : 100%;
            }
            .advanced {
                padding: 10px;
                box-shadow: 0 0 5px #888 inset;
                margin: 0px 10px 25px 20px;
            }
        </style>

        <div layout horizontal>
            <div hidden?="{{filters.length == 0}}">
                Filters:&nbsp;&nbsp;
            </div>
            <div flex>
                <template repeat="{{filter, i in filters}}">
                    <a class="btn btn-default" filterIndex="{{i}}" on-click="{{removeFilter}}"><span style="color:#888">{{filter.key}}:</span> <b>{{filter.value}}</b></a>
                </template>
            </div>
        </div>

        <div style="position:relative">
            <div id="root" style="height: 450px"></div>
            <div class="loading" hidden?="{{!loading}}">
                Loading...
            </div>
        </div>

        <div>
            <div>
                <a class="btn btn-link" on-tap="{{toggleAdvanced}}">Advanced</a>
            </div>
            <div class="advanced" hidden?="{{!showAdvanced}}">

                <h4>Set Wavelength Range</h4>
                <table class="table">
                    <tr>
                        <td>Min Wavelength ({{wavelengths[0]}})</td>
                        <td>
                            <input id="minWavelength" type="number" on-change="{{setMinWavelength}}" />
                        </td>
                    </tr>
                     <tr>
                        <td>Max Wavelength ({{wavelengths[wavelengths.length-1]}})</td>
                        <td>
                            <input id="maxWavelength" type="number" on-change="{{setMaxWavelength}}" />
                        </td>
                    </tr>
                </table>

                <h4>Add Filter from Dataset</h4>
                <table class="table">
                    <tr>
                        <td>Attribute</td>
                        <td>
                            <select value="{{dsFilter}}">
                                <template repeat="{{attr in dsFilters}}">
                                    <option value="{{attr}}">{{attr}}</option>
                                </template>
                            </select>
                        </td>
                    <tr hidden?="{{dsFilter == ''}}">
                        <td>Value</td>
                        <td>
                            <select value="{{dsFilterValue}}" on-change="{{addDsFilter}}">
                                <template repeat="{{val in dsFilterValues}}">
                                    <option value="{{val}}">{{val}}</option>
                                </template>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
        </div>

        <div layout horizontal>
            <div>
                <div style="margin-bottom: 15px">
                    Spectra #
                    <select value="{{selectedIndex}}" on-change="{{_updateFromSelect}}">
                        <template repeat="{{index in indexes}}">
                            <option value="{{index}}">{{index}}</option>
                        </template>
                    </select>
                    of {{totalSpectra}}
                </div>
                <div style="margin-bottom: 15px">
                    <a class="btn btn-default" on-tap="{{print}}">Printable Version</a>
                </div>
                <div>
                    <a class="btn btn-default" href="{{rest}}" target="_blank">Rest Link</a>
                </div>
            </div>
            <div flex>
                <div class="metadata" hidden?="{{metadata.length == 0 }}">
                    <template repeat="{{m in metadata}}">
                        <div class="{{m.class}}" filterKey="{{m.key}}" filterValue="{{m.value}}" on-click="{{addFilterFromBtn}}">
                            <span style="color:#888">{{m.key}}:</span> <b>{{m.value}}</b>
                        </div>
                    </template>
                </div>
            </div>
        </div>

    </template>
    <script>
        Polymer('esis-spectra-viewer', {
            dt : null,
            dataArray : [],
            chart : null,
            loading: false,

            showAdvanced : false,

            rest : '',

            ptRegex1 : /^-?\d+\.?\d*$/,
            ptRegex2 : /^-?\d*\.\d+$/,

            dsFilter : '',
            dsFilters : [],
            dsFilterValue : '',
            dsFilterValues : [],

            selectedIndex : 0,
            totalSpectra : 0,
            indexes : [],
            metadata : [],

            filters : [],

            ignoreList : ['_id', 'datapoints', 'ecosis'],

            onLoadHandlerSet : false,

            wavelengths : [],
            maxWavelength : 0,
            minWavelength : 0,

            observe : {
                package : '_update',
                dsFilter : '_updateFilterValues'
            },

            ready : function() {
                $(window).on('resize', function(){
                    this.redraw();
                }.bind(this));
            },

            setOnloadHandler : function() {
                if( this.onLoadHandlerSet ) return;

                console.log('callback set');

                // put in global scope by cwn-datastore
                chartLoadHandlers.push(function(){
                    this._update();
                }.bind(this));
            },
            
            print : function() {
                window.open(this.chart.getImageURI());
            },

            _update : function() {
                if( !window.google.visualization ) return this.setOnloadHandler();
                if( !window.google.visualization.LineChart ) return this.setOnloadHandler();

                if( !this.chart ) {
                    this.chart = new google.visualization.LineChart(this.$.root);
                }

                this.indexes = [];
                this.selectedIndex = 0;
                this.totalSpectra = this.spectra_count;

                this.dsFilters = [''];
                for( var key in this.item ) {
                    if( this.ignoreList.indexOf(key) > -1 ) continue;
                    this.dsFilters.push(key);
                }

                // if there is a group_by attribute, set as default filter
                this.filters = [];
                if( this.item.ecosis.group_by && this.item.ecosis.group_by != '' ) {
                    this._addFilter(this.item.ecosis.group_by, this.item[this.item.ecosis.group_by][0]);
                }

                this._updateDataTable(true);
            },

            _updateFilterValues : function() {
                this.dsFilterValues = [''];
                var attr = this.item[this.dsFilter];
                if( !attr ) return;

                for( var i = 0; i < attr.length; i++ ) {
                    this.dsFilterValues.push(attr[i]);
                }
            },

            addDsFilter : function() {
                this.async(function(){
                    if( this.dsFilterValue == '' ) return;

                    this._addFilter(this.dsFilter, this.dsFilterValue, true);
                    this.dsFilter = '';
                });
            },

            _updateFromSelect : function() {
                this._updateDataTable(false);
            },

            _updateDataTable : function(resetWavelengths) {
                this.loading = true;

                var filters = '';
                var fArray = [];
                for( var i = 0; i < this.filters.length; i++ ) {
                    var obj = {};
                    obj[this.filters[i].key] = this.filters[i].value;
                    fArray.push(obj);
                }
                if( this.filters.length > 0 ) {
                    filters = '&filters='+encodeURIComponent(JSON.stringify(fArray));
                }

                var url = '/rest/getSpectra?package_id='+this.package.id+filters+'&index='+this.selectedIndex;

                $.ajax({
                    url : url,
                    success : function(resp) {
                        this.metadata = [];
                        this.indexes = [];
                        this.wavelengths = [];
                        this.totalSpectra = resp.total;
                        resp = resp.item;

                        for( var i = 0; i < this.totalSpectra; i++ ) this.indexes.push(i);

                        this.dataArray = [];
                        var pt;
                        for( var i = 0; i < resp.datapoints.length; i++ ) {
                            pt = resp.datapoints[i];
                            if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                                this.dataArray.push([parseFloat(pt.key), parseFloat(pt.value)]);
                            } else {
                                metadata.push(pt);
                            }
                        }


                        for( var key in resp ) {
                            if( this.ignoreList.indexOf(key) == -1 && typeof resp[key] == 'string' && resp[key] != '' ) {
                                this.metadata.push({
                                    key : key,
                                    value : resp[key],
                                    class : this._getMetadataClass(key, resp[key])
                                })
                            }
                        }

                        this.dataArray.sort(function(a, b){
                            if( a[0] < b[0] ) return -1;
                            if( a[0] > b[0] ) return 1;
                            return 0;
                        });
                        for( var i = 0; i < this.dataArray.length; i++ ) {
                            this.wavelengths.push(this.dataArray[i][0]);
                        }

                        if( resetWavelengths ) {
                            this.setWavelength('min', this.wavelengths[0]);
                            this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                        } else {
                            if( this.minWavelength < this.wavelengths[0] ) {
                                this.setWavelength('min', this.wavelengths[0]);
                            }
                            if( this.maxWavelength > this.wavelengths[this.wavelengths.length-1] ) {
                                this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                            }
                        }

                        this.dataArray.splice(0,0,['Wavelength','Reflectance']);

                        this.filterByWavelength();
                        this.loading = false;
                    }.bind(this)
                });

                this.rest = window.location.origin+url;
            },

            setWavelength : function(type, value) {
                this.$[type+'Wavelength'].value = value;
                this[type+'Wavelength'] = value;
            },

            setMinWavelength : function() {
                this.minWavelength = parseFloat(this.$.minWavelength.value);
                if( this.minWavelength < this.wavelengths[0] ) {
                    this.setWavelength('min', this.wavelengths[0]);
                } else if ( this.minWavelength > this.maxWavelength ) {
                    this.setWavelength('min', this.maxWavelength);
                }
                this.filterByWavelength();
            },

            setMaxWavelength : function() {
                this.maxWavelength = parseFloat(this.$.maxWavelength.value);
                if( this.maxWavelength >= this.wavelengths[this.wavelengths.length-1] ) {
                    this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                } else if ( this.minWavelength > this.maxWavelength ) {
                    this.setWavelength('max', this.minWavelength);
                }
                this.filterByWavelength();
            },

            filterByWavelength : function() {
                var arr = [this.dataArray[0]];
                for( var i = 1; i < this.dataArray.length; i++ ) {
                    if( this.dataArray[i][0] >= this.minWavelength && 
                        this.dataArray[i][0] <= this.maxWavelength ) {
                        arr.push([this.dataArray[i][0]+'', this.dataArray[i][1]]);
                    }
                }

                this.dt = google.visualization.arrayToDataTable(arr);
                this.redraw();
            },

            redraw : function() {
                if( !this.chart || !this.dt ) return;

                var options = {
                    legend : {
                        position : 'none'
                    },
                    vAxis : {},
                    hAxis : {}
                };

                if( this.label && this.label != '' ) {
                    options.title = this.label;
                }
                if( this.xlabel && this.xlabel != '' ) {
                    options.hAxis.title = this.xlabel;
                }
                if( this.ylabel && this.ylabel != '' ) {
                    options.vAxis.title = this.ylabel;
                }

                 options.animation = {
                        duration : 750,
                        easing : 'out'
                    }

                this.chart.draw(this.dt, options);
            },

            removeFilter : function(e) {
                var index = parseInt(e.currentTarget.getAttribute('filterIndex'));
                this._removeFilter(index, 1, true);
            },

            addFilterFromBtn : function(e) {
                this._addFilter(e.currentTarget.getAttribute('filterKey'), e.currentTarget.getAttribute('filterValue'), true);
            },

            _getMetadataClass : function(key, value) {
                for( var i = 0; i < this.filters.length; i++ ) {
                    if( this.filters[i].key == key && this.filters[i].value == value ) {
                        return 'selected';
                    }
                }
                return '';
            },

            _removeFilter : function(index, update) {
                var item = this.filters.splice(index, 1)[0];

                for( var i = 0; i < this.metadata.length; i++ ) {
                    if( this.metadata[i].key == item.key && this.metadata[i].value == item.value ) {
                        this.metadata[i].class = '';
                        break;
                    }
                }

                if( update ) {
                    this.selectedIndex = 0;
                    this._updateDataTable();
                }
            },

            _addFilter : function(key, value, update) {
                for( var i = 0; i < this.filters.length; i++ ) {
                    if( this.filters[i].key == key ) {
                        _removeFilter(i);
                        break;
                    }
                }

                for( var i = 0; i < this.metadata.length; i++ ) {
                    if( this.metadata[i].key == key && this.metadata[i].value == value ) {
                        this.metadata[i].class = 'selected';
                        break;
                    }
                }

                this.filters.push({
                    key : key,
                    value : value
                });
                if( update ) {
                    this.selectedIndex = 0;
                    this._updateDataTable(false);
                }
            },

            toggleAdvanced : function() {
                this.showAdvanced = !this.showAdvanced;
            }

        });
    </script>
</polymer-element>