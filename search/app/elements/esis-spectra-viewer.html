<dom-module id="esis-spectra-viewer">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <h5 style="color: #333">
      Spectra #&nbsp;
      <select on-change="updateFromSelect" id="selectSpectraInput" style="min-width:100px"></select>
      &nbsp;of <span id="totalSpectraLabel"></span>
      <span class="label label-success" id="loadingPanel">
        <i class="fa fa-spinner fa-spin"></i> Loading...
      </span>
    </h5>

    <div style="position:relative">
        <div id="root" style="height: 450px"></div>
    </div>

    <div class="well">
      <div class="row">
        <div class="col-sm-2">Wavelength Range</div>
        <div class="col-sm-10" id="sliderRoot"></div>
      </div>

      <div class="row" style="margin-top: 20px">
        <div class="col-sm-2">Add Filter</div>
        <div class="col-sm-10"><select id="spectraFilterSelector" on-change="addFilterFromSelector" class="form-control"></select></div>
      </div>

      <div class="row" style="margin-top: 20px; display:none" id="filterBtnsPanelOuter">
        <div class="col-sm-2">Current Filters</div>
        <div class="col-sm-10" id="filterBtnsPanel"></div>
      </div>

      <div style="margin-top: 50px">
        <div class="row">
          <div class="col-sm-6">
            <a class="btn btn-default" on-click="print"><i class="fa fa-print"></i> Printable Chart</a>
          </div>
          <div class="col-sm-6" style="text-align:right">
            <a class="btn btn-link" id="restLink" target="_blank"><i class="fa fa-link"></i> Developer Rest Link</a>
            <a class="btn btn-link" href="http://cstars.github.io/esis/" target="_blank"><i class="fa fa-book"></i> EcoSIS API</a>
          </div>
        </div>
      </div>
    </div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'esis-spectra-viewer',

    properties : {
      package : {
        type: String
      },
      total : {
        type : String
      }
    },

    attached : function() {
        $(window).on('resize', function(){
            this.redraw();
        }.bind(this));

        this.item = {};
        this.ptRegex1 = /^-?\d+\.?\d*$/;
        this.ptRegex2 = /^-?\d*\.\d+$/;

        this.ignoreList = ['_id', 'datapoints', 'ecosis'];


    },

    resetSlider : function() {
      this.$.sliderRoot.innerHTML = '<input type="text" data-slider-min="'+this.minWavelength+'" data-slider-max="'+this.maxWavelength+
          '" data-slider-step="1" data-slider-value="['+this.minWavelength+','+this.maxWavelength+']" id="slider" />';
      this.$.slider = this.$.sliderRoot.querySelector('#slider');

      this.slider = $(this.$.slider).slider({});
      $(this.$.slider).parent().width('100%');
      this.slider.on('slideStop', function(e){
        this.minWavelength = e.value[0];
        this.maxWavelength = e.value[1];
        this.filterByWavelength();
      }.bind(this));
    },

    setOnloadHandler : function() {
        if( this.onLoadHandlerSet ) return;

        // in global scope
        chartLoadHandlers.push(this.update.bind(this));
    },

    print : function() {
        window.open(this.chart.getImageURI());
    },

    update : function() {
        if( !window.google.visualization ) return this.setOnloadHandler();
        if( !window.google.visualization.LineChart ) return this.setOnloadHandler();

        if( !this.chart ) {
            this.chart = new google.visualization.LineChart(this.$.root);
        }

        this.indexes = [];
        this.selectedIndex = 0;
        this.totalSpectra = parseInt(this.total);

        this.dsFilters = [''];
        for( var key in this.item ) {
            if( this.ignoreList.indexOf(key) > -1 ) continue;
            this.dsFilters.push(key);
        }

        this.filters = [];


        this.updateDataTable(true);
    },

    updateFilterValues : function() {
        this.dsFilterValues = [''];
        var attr = this.item[this.dsFilter];
        if( !attr ) return;

        for( var i = 0; i < attr.length; i++ ) {
            this.dsFilterValues.push(attr[i]);
        }
    },

    addDsFilter : function() {
        this.async(function(){
            if( this.dsFilterValue == '' ) return;

            this.addFilter(this.dsFilter, this.dsFilterValue, true);
            this.dsFilter = '';
        });
    },

    updateFromSelect : function(e) {
      this.selectedIndex = parseInt(e.currentTarget.value);
      this.updateDataTable(false);
    },

    compareUpdated : function() {
        if( this.showCompare ) {
            this.updateDataTable(false);
        }
    },

    updateDataTable : function(resetWavelengths) {
        this.$.loadingPanel.style.display = 'inline-block';

        var filters = '';
        var fArray = [];
        for( var i = 0; i < this.filters.length; i++ ) {
            var obj = {};
            obj[this.filters[i].key] = this.filters[i].value;
            fArray.push(obj);
        }

        if( this.filters.length > 0 ) {
            filters = '&filters='+encodeURIComponent(JSON.stringify(fArray));
        }

        var url = '/rest/getSpectra?package_id='+this.package+filters+'&index='+this.selectedIndex;

        if( this.xhr != null ) this.xhr.abort();

        this.xhr = $.ajax({
            url : url,
            success : function(resp) {
              this.$.loadingPanel.style.display = 'none';
              this.xhr = null;

              this.totalSpectra = resp.total;
              this.item = resp.item;
              this.createTableArray(resetWavelengths);

              this.updateIndexSelector();
              this.updateFilters();
            }.bind(this)
        });

        this.$.restLink.setAttribute('href', window.location.origin+url);
    },

    updateIndexSelector : function() {
      var options = '';
      for( var i = 0; i < this.totalSpectra; i++ ) {
        options += '<option value="'+i+'" '+(i == this.selectedIndex ? 'selected' : '')+'>'+i+'</option>';
      }
      this.$.selectSpectraInput.innerHTML = options;

      this.$.totalSpectraLabel.innerText = this.totalSpectra;
    },

    updateFilters : function() {
      var filterBtns = '';
      for( var key in this.item ) {
        if( this.hasFilter(key, this.item[key]) ) continue;

        if( key == 'ecosis' || key == '_id' || key == 'datapoints' ) continue;
        filterBtns += '<option value="'+key+this.item[key]+'">'+key+': '+this.item[key]+'</option>';
      }

      if( filterBtns.length == 0 ) {
        filterBtns = '<option>No Additional filters available</option>';
        this.$.spectraFilterSelector.setAttribute('disabled', '');
      } else {
        filterBtns = '<option></option>' + filterBtns;
        this.$.spectraFilterSelector.removeAttribute('disabled');
      }

      this.$.spectraFilterSelector.innerHTML = filterBtns;

      filterBtns = '';
      for( var i = 0; i < this.filters.length; i++ ) {
        filterBtns += '<a class="btn btn-primary btn-sm" index="'+i+'"><i class="fa fa-times"></i> '+this.filters[i].key+': '+this.filters[i].value+'</a>';
      }

      if( filterBtns.length > 0 ) {
        this.$.filterBtnsPanelOuter.style.display = 'block';
        this.$.filterBtnsPanel.innerHTML = filterBtns;
        $(this.$.filterBtnsPanel)
          .find('a')
          .on('click', this.removeFilterFromBtn.bind(this));
      } else {
        this.$.filterBtnsPanelOuter.style.display = 'none';
        this.$.filterBtnsPanel.innerHTML = '';
      }

    },

    createTableArray : function(resetWavelengths) {
        if( typeof resetWavelengths == 'object' ) resetWavelengths = false;

        this.indexes = [];
        this.wavelengths = [];

        for( var i = 0; i < this.totalSpectra; i++ ) this.indexes.push(i);

        this.dataArray = [];
        var wavelengthHash = {}, hasCurrent = false;

        if( this.totalSpectra == 0 ) return;

        if( this.showCompare ) {
            var i;
            for( i = 0; i < this.compareList.length; i++ ) {
                this.addToDataArray(this.compareList[i].spectra, wavelengthHash, i);
                if( this.compareList[i].spectra._id == this.resp._id ) hasCurrent = true;
            }

            if( !hasCurrent ) {
                this.addToDataArray(this.resp, wavelengthHash, i);
            }

            for( var key in wavelengthHash ) {
                this.dataArray.push( wavelengthHash[key] );
            }

        } else {
            for( var k in this.item.datapoints ) {
                var v = this.item.datapoints[k];
                if( this.ptRegex1.exec(k) || this.ptRegex2.exec(k) ) {
                    this.dataArray.push([parseFloat(k), parseFloat(v)]);
                }
            }
        }

        this.dataArray.sort(function(a, b){
            if( a[0] < b[0] ) return -1;
            if( a[0] > b[0] ) return 1;
            return 0;
        });

        for( var i = 0; i < this.dataArray.length; i++ ) {
            this.wavelengths.push(this.dataArray[i][0]);
        }

        if( resetWavelengths ) {

          this.minWavelength = this.wavelengths[0];
          this.maxWavelength = this.wavelengths[this.wavelengths.length-1];
          this.resetSlider();

        } else {
            if( this.minWavelength > this.wavelengths[0] ) {
                this.setWavelength('min', this.wavelengths[0]);
            }
            if( this.maxWavelength < this.wavelengths[this.wavelengths.length-1] ) {
                this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
            }
        }

        if( this.showCompare ) {
            var header = ['Wavelength'];
            for( var i = 0; i < this.compareList.length; i++ ) {
                if( this.compareList[i].spectra._id == this.resp._id ) {
                    header.push(this.compareList[i].name+' (Current)');
                } else {
                    header.push(this.compareList[i].name);
                }
            }
            if( !hasCurrent ) {
                header.push('Current');
            }
            this.dataArray.splice(0,0,header);
        } else {
            this.dataArray.splice(0,0,['Wavelength','Reflectance']);
        }


        this.filterByWavelength();
        this.loading = false;
    },

    addToDataArray : function(spectra, wavelengthHash, i) {
        var cWaves = [], pt;
        for( var j = 0; j < spectra.datapoints.length; j++ ) {
            pt = spectra.datapoints[j];

            if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                if( wavelengthHash[pt.key] !== undefined ) {
                    wavelengthHash[pt.key].push(parseFloat(pt.value));
                } else {
                    wavelengthHash[pt.key] = [parseFloat(pt.key)];
                    for( var z = 0; z < i; z++ ) wavelengthHash[pt.key].push(null);
                    wavelengthHash[pt.key].push(parseFloat(pt.value));
                }
                cWaves.push(pt.key);
            }
        }

        // add any waves this one is missing
        for( var key in wavelengthHash ) {
            if( cWaves.indexOf(key) > -1 ) continue;
            wavelengthHash[key].push(null);
        }
    },

    setWavelength : function(type, value) {
        this[type+'Wavelength'] = value;
        this.slider.slider('setValue', [this.minWavelength, this.maxWavelength]);
    },

    filterByWavelength : function() {
        var arr = [this.dataArray[0]];
        for( var i = 1; i < this.dataArray.length; i++ ) {
            if( this.dataArray[i][0] >= this.minWavelength &&
                this.dataArray[i][0] <= this.maxWavelength ) {

                var clone = this.dataArray[i].slice(0);
                clone[0] = clone[0]+'';
                arr.push(clone);
            }
        }

        this.dt = google.visualization.arrayToDataTable(arr);
        this.redraw();
    },

    redraw : function() {
        if( !this.chart || !this.dt ) return;

        var options = {
            legend : {
                position : 'none'
            },
            vAxis : {},
            hAxis : {}
        };

        if( this.label && this.label != '' ) {
            options.title = this.label;
        }
        if( this.xlabel && this.xlabel != '' ) {
            options.hAxis.title = this.xlabel;
        }
        if( this.ylabel && this.ylabel != '' ) {
            options.vAxis.title = this.ylabel;
        }

        options.animation = {
            duration : 750,
            easing : 'out'
        }

        this.chart.draw(this.dt, options);
    },

    removeFilterFromBtn : function(e) {
        var index = parseInt(e.currentTarget.getAttribute('index'));
        this.removeFilter(index, 1, true);
    },

    addFilterFromSelector : function(e) {
      var value = e.currentTarget.value;

      for( var key in this.item ) {
        if( key == 'ecosis' || key == '_id' || key == 'datapoints' ) continue;
        if( value == key+this.item[key] ) {
          this.addFilter(key, this.item[key], true);
          return;
        }
      }
    },

    removeFilter : function(index, update) {
        var item = this.filters.splice(index, 1)[0];

        if( update ) {
            this.selectedIndex = 0;
            this.updateDataTable();
        }

        this.fire('filter-update', this.filters);
    },

    hasFilter : function(key, value) {
      for( var i = 0; i < this.filters.length; i++ ) {
          if( this.filters[i].key == key && this.filters[i].value == value ) {
              return true;
          }
      }
      return false;
    },

    addFilter : function(key, value, update) {
        for( var i = 0; i < this.filters.length; i++ ) {
            if( this.filters[i].key == key ) {
                this.removeFilter(i);
                break;
            }
        }


        this.filters.push({
            key : key,
            value : value
        });

        if( update ) {
            this.selectedIndex = 0;
            this.updateDataTable(false);
        }

        this.fire('filter-update', this.filters);
    },

    toggleAdvanced : function() {
      $(this.$.advancedPanel).toggle();
    }
  });
</script>
