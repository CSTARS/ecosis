<dom-module id="spectra-viewer">
  <template>
    <style>
      :host {
        display: block;
      }
      .attributes {
        /*max-height: 300px;
        overflow: auto;*/
        margin: 0 15px;
      }
      .section {
        padding-bottom: 30px;
        margin-bottom: 30px;
        border-bottom: 1px dashed #eee;
      }

    </style>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h5 style="color: #333" id="selector" >
          <div class="layout horizontal">
            <div class="flex">
              <span id="countLabel">
                Spectra
                <span id="currentSpectra" style="color:#888"></span>
                of
                <span id="totalSpectraLabel" style="color:#888"></span>
              </span>

              <small id="loadingPanel">Loading...</small>
            </div>

            <div class="checkbox" style="margin:0">
              <label><input type="checkbox" on-click="toggleStats" /> Stats</label>
            </div>
        </h5>
      </div>
      <div class="panel-body">

        <div class="section">
          <h4>Select &amp; Filter</h4>

          <div class="row" id="spectraSliderRow">
            <div class="col-sm-2 col-sm-offset-1">Select</div>
            <div class="col-sm-8">
              <div class="layout horizontal">
                <div>
                  <a class="btn btn-default" on-click="previous" id="previous" style="margin-right: 15px" ><i class="fa fa-arrow-left"></i></a>
                </div>
                <div class="flex" id="sliderSpectraRoot"></div>
                <div>
                  <a class="btn btn-default" on-click="next" id="next" style="margin-left: 15px"><i class="fa fa-arrow-right"></i></a>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top: 20px" id="filterPanel">
            <div class="col-sm-2 col-sm-offset-1">Filter</div>
            <div class="col-sm-4 "><select id="spectraFilterSelector" on-change="setFilterValues" class="form-control"></select></div>
            <div class="col-sm-4 "><select id="spectraFilterValueSelector" on-change="setDsFilter" class="form-control"></select></div>
          </div>
        </div>

        <div class="section">
          <h4>Measurement</h4>
          <div id="hoverInfo" style="position:absolute;z-index:50;padding: 5px; background-color: rgba(255, 255, 255, .8); margin-top:-30px;display:none"></div>

          <div id="root" style="height: 300px; padding: 15px"></div>

          <div style="padding: 0 25px">
            <div id="sliderRoot"></div>
            <div class="help-block" style="text-align:center">Filter Wavelength</div>
          </div>
        </div>

        <div id="metadataPanel">
          <h4>Metadata</h4>
          <div id="photoPreview" style="text-align:center"></div>
          <div class="row">
            <div class="col-md-6">
              <div class="attributes" id="attributes1"></div>
            </div>
            <div class="col-md-6">
              <div class="attributes" id="attributes2"></div>
            </div>
          </div>
        </div>

      </div>
      <div class="panel-footer">

        <div class="row">
          <div class="col-sm-2">
            <!-- TODO: implement when paper chart supports
              <a class="btn btn-default" on-click="print"><i class="fa fa-print"></i> Printable Chart</a>
            -->
          </div>
          <div class="col-sm-10" style="text-align:right">
            <div>
              <a class="btn btn-link" id="restLink" target="_blank"><i class="fa fa-link"></i> Spectra API Link</a>
              <a class="btn btn-link" href="http://cstars.github.io/ecosis/" target="_blank"><i class="fa fa-book"></i> EcoSIS API Documentation</a>
            </div>
            <div class="help-block">
              The API Link shows the HTTP request for rendering the above chart.  For more information
              see the EcoSIS API documentation.
            </div>
          </div>
        </div>

      </div>
    </div>


  </template>

  <script>
    Polymer({
      is : 'spectra-viewer',

      properties : {
        package : {
          type: String
        },
        total : {
          type : String
        }
      },

      attached : function() {
        this.resizeTimer = -1;
        $(window).on('resize', this.resize.bind(this));

          this.item = {};
          this.ptRegex1 = /^-?\d+\.?\d*$/;
          this.ptRegex2 = /^-?\d*\.\d+$/;

          this.stats = {
            key : null,
            value : {}
          };

          this.ignoreList = ['_id', 'datapoints', 'ecosis'];
      },

      onShow : function() {
        this.resize();
      },

      resize : function() {
        if( this.resizeTimer !== -1 ) {
          clearTimeout(this.resizeTimer);
        }

        this.resizeTimer = setTimeout(function(){
          this.resizeTimer = -1;
          this.redraw();
        }.bind(this), 100);
      },

      resetSlider : function() {
        this.absoluteMax = this.maxWavelength;
        this.absoluteMin = this.minWavelength;

        this.$.sliderRoot.innerHTML = '<input type="text" data-slider-min="'+this.minWavelength+'" data-slider-max="'+this.maxWavelength+
            '" data-slider-step="1" data-slider-value="['+this.minWavelength+','+this.maxWavelength+']" id="slider" />';
        this.$.slider = this.$.sliderRoot.querySelector('#slider');

        this.slider = $(this.$.slider).slider({});

        $(this.$.slider).parent().width('100%');

        this.slider.on('slideStop', function(e){
          this.minWavelength = e.value[0];
          this.maxWavelength = e.value[1];

          if( isNaN(this.minWavelength) ) {
            this.minWavelength = 0;
          }
          if( isNaN(this.maxWavelength) ) {
            this.maxWavelength = 0;
          }

          this.filterByWavelength();
        }.bind(this));

        if( this.totalSpectra <= 1 ) {
          this.$.sliderSpectraRoot.innerHTML = '';
          return;
        }

        this.$.sliderSpectraRoot.innerHTML = '<input type="text" data-slider-min="1" data-slider-max="'+this.totalSpectra+
            '" data-slider-step="1" data-slider-value="1" id="spectraSlider" />';
        this.$.spectraSlider = this.$.sliderSpectraRoot.querySelector('#spectraSlider');

        this.spectraSlider = $(this.$.spectraSlider).slider({});

        $(this.$.spectraSlider).parent().width('100%');

        this.spectraSlider.on('slideStop', function(e){
          if( isNaN(e.value) ) return; // this happens?

          this.selectedIndex = e.value-1;
          this.updateDataTable(false);
        }.bind(this));
      },

      setOnloadHandler : function() {
          if( this.onLoadHandlerSet ) return;

          // in global scope
          chartLoadHandlers.push(this.update.bind(this));
      },

      print : function() {
          window.open(this.chart.getImageURI());
      },

      update : function(packageData) {
          if( packageData ) this.packageData = packageData;
          if( !window.google.charts ) return this.setOnloadHandler();
          if( !window.google.charts.Line ) return this.setOnloadHandler();

          if( !this.chart ) {
              // this.chart = new google.charts.Line(this.$.root);
              this.chart = new google.visualization.LineChart(this.$.root);

              google.visualization.events.addListener(this.chart, 'onmouseover', this.onMouseOverChart.bind(this));
              google.visualization.events.addListener(this.chart, 'onmouseout', this.onMouseOutChart.bind(this));
          }

          this.indexes = [];
          this.selectedIndex = 0;
          this.totalSpectra = parseInt(this.total);

          this.dsFilters = {};
          var filters = ['Common Name', 'Latin Genus', 'Latin Species'];
          for( var i = 0; i < filters.length; i++ ) {
            if( !packageData[filters[i]] ) continue;

            packageData[filters[i]].sort();
            this.dsFilters[filters[i]] = packageData[filters[i]];
          }

          if( Object.keys(this.dsFilters).length == 0 ) {
            this.$.filterPanel.style.display = 'none';
          } else {
            this.$.filterPanel.style.display = 'block';

            var html = '<option value="">None</option>';
            for( var k in this.dsFilters ) {
              html += '<option value="'+k+'">'+k+'</option>';
            }
            this.$.spectraFilterSelector.innerHTML = html;
            this.setFilterValues();
          }
          this.activeFilter = null;


          this.updateDataTable(true);
      },

      setFilterValues : function() {
          var f = this.$.spectraFilterSelector.value;

          if( f == '' ) {
            this.$.spectraFilterValueSelector.setAttribute('disabled', 'disabled');
            this.$.spectraFilterValueSelector.innerHTML = '';
            this.activeFilter = null;

            if( this.showingStats) this.updateStats();
            else this.updateDataTable();

            return;
          }

          var html = '';

          for( var i = 0; i < this.packageData[f].length; i++ ) {
            html += '<option value="'+this.packageData[f][i]+'">'+this.packageData[f][i]+'</option>';
          }
          this.$.spectraFilterValueSelector.innerHTML = html;
          this.$.spectraFilterValueSelector.removeAttribute('disabled');
          this.setDsFilter();
      },

      setDsFilter : function() {
          this.activeFilter = {};
          this.activeFilter[this.$.spectraFilterSelector.value] = this.$.spectraFilterValueSelector.value;
          this.selectedIndex = 0;

          if( this.showingStats) {
            this.updateStats();
          } else {
            this.updateDataTable(false, this.resetSlider.bind(this));
          }
      },

      compareUpdated : function() {
          if( this.showCompare ) {
              this.updateDataTable(false);
          }
      },

      updateDataTable : function(resetWavelengths, callback) {
          this.$.loadingPanel.style.display = 'inline-block';
          this.$.loadingPanel.innerHTML = 'Loading...';

          var filters = '';

          if( this.activeFilter ) {
              filters = '&filters='+encodeURIComponent(JSON.stringify([this.activeFilter]));
          }

          var url = '/spectra/query?package_id='+this.package+filters+'&start='+this.selectedIndex+'&stop='+(this.selectedIndex+1);

          if( this.xhr != null ) this.xhr.abort();

          this.xhr = $.ajax({
              url : url,
              success : function(resp) {
                this.$.loadingPanel.style.display = 'none';
                this.xhr = null;

                this.totalSpectra = resp.total;

                // we should only be accessing one spectra at a time
                if( resp.items.length > 0 ) {
                  this.item = resp.items[0];
                }

                this.createTableArray(resetWavelengths);
                this.updateAttributes();

                this.updateIndexSelector();
                if( callback ) callback();
              }.bind(this)
          });

          this.$.restLink.setAttribute('href', window.location.origin+url);
      },

      updateAttributes : function() {
        var units = {};
        if( this.packageData.ecosis.spectra_metadata_schema && this.packageData.ecosis.spectra_metadata_schema.units ) {
          units = this.packageData.ecosis.spectra_metadata_schema.units;
        }

        var table1 = '<table class="table">';
        var table2 = '<table class="table">';
        var c = 0;

        for( var attr in this.item) {
          if( attr == 'ecosis' || attr == '_id' || attr == 'datapoints' || attr == 'photo' ) continue;

          var unitLabel = '';
          if( units[attr] ) {
            unitLabel = ' <span style="color:#888;font-size:80%">('+units[attr]+')</span>';
          }

          if( c % 2 === 0 ) {
            table1 += '<tr><td><b>'+attr.replace(/(-|_)/g,' ')+'</b>'+unitLabel+'</td><td>'+this.item[attr]+'</td></tr>';
          } else {
            table2 += '<tr><td><b>'+attr.replace(/(-|_)/g,' ')+'</b>'+unitLabel+'</td><td>'+this.item[attr]+'</td></tr>';
          }
          c++;
        }

        this.$.attributes1.innerHTML = table1+'</table>';
        this.$.attributes2.innerHTML = table2+'</table>';

        var photoUrl = '';
        for( var key in this.item ) {
          if( key.trim().toLowerCase() === 'photo' ) {
            photoUrl = this.item[key];
            break;
          }
        }

        if( photoUrl ) {
          this.$.photoPreview.innerHTML = '<img src="'+photoUrl+'" class="img img-thumbnail" style="margin:10px; max-height: 350px" />';
          $(this.$.photoPreview)
            .find('img')
            .on('error', function(){
              this.$.photoPreview.innerHTML = '<a href="'+photoUrl+'" target="_blank" >Spectra Photo</a>';
            }.bind(this));
        } else {
          this.$.photoPreview.innerHTML = '';
        }
      },

      previous : function() {
        if( this.selectedIndex == 0 ) return;
        this.selectedIndex--;
        this.spectraSlider.slider('setValue',this.selectedIndex+1);
        this.updateDataTable(false);
      },

      next : function() {
        if( this.selectedIndex >= this.totalSpectra - 1 ) return;
        this.selectedIndex++;
        this.spectraSlider.slider('setValue',this.selectedIndex+1);
        this.updateDataTable(false);
      },

      updateIndexSelector : function() {
        if( !this.spectraSlider ) return;
        this.$.currentSpectra.innerHTML = (this.selectedIndex+1);
        this.spectraSlider.slider('setValue',this.selectedIndex+1);
        this.$.totalSpectraLabel.innerHTML = this.totalSpectra;
      },

      createTableArray : function(resetWavelengths) {
          if( typeof resetWavelengths == 'object' ) resetWavelengths = false;

          this.indexes = [];
          this.wavelengths = [];

          for( var i = 0; i < this.totalSpectra; i++ ) this.indexes.push(i);

          this.dataArray = [];
          var wavelengthHash = {}, hasCurrent = false;

          if( this.totalSpectra == 0 ) return;

          if( this.showCompare ) {
              var i;
              for( i = 0; i < this.compareList.length; i++ ) {
                  this.addToDataArray(this.compareList[i].spectra, wavelengthHash, i);
                  if( this.compareList[i].spectra._id == this.resp._id ) hasCurrent = true;
              }

              if( !hasCurrent ) {
                  this.addToDataArray(this.resp, wavelengthHash, i);
              }

              for( var key in wavelengthHash ) {
                  this.dataArray.push( wavelengthHash[key] );
              }

          } else {
              for( var k in this.item.datapoints ) {
                  var v = this.item.datapoints[k];
                  if( this.ptRegex1.exec(k) || this.ptRegex2.exec(k) ) {
                      this.dataArray.push([parseFloat(k), parseFloat(v)]);
                  }
              }
          }

          this.dataArray.sort(function(a, b){
              if( a[0] < b[0] ) return -1;
              if( a[0] > b[0] ) return 1;
              return 0;
          });

          for( var i = 0; i < this.dataArray.length; i++ ) {
              this.wavelengths.push(this.dataArray[i][0]);
          }

          if( resetWavelengths ) {

            this.minWavelength = this.wavelengths[0];
            this.maxWavelength = this.wavelengths[this.wavelengths.length-1];

            if( isNaN(this.minWavelength) ) {
              this.minWavelength = 0;
            }
            if( isNaN(this.maxWavelength) ) {
              this.maxWavelength = 0;
            }

            this.resetSlider();

          } else {
              var changed = false;
              if( this.absoluteMin > this.wavelengths[0] ) {
                  this.setWavelength('min', this.wavelengths[0]);
                  changed = true;
              }
              if( this.absoluteMax < this.wavelengths[this.wavelengths.length-1] ) {
                  this.setWavelength('max', this.wavelengths[this.wavelengths.length-1]);
                  changed = true;
              }
              if( changed ) this.resetSlider();
          }

          if( this.showCompare ) {
              var header = ['Wavelength'];
              for( var i = 0; i < this.compareList.length; i++ ) {
                  if( this.compareList[i].spectra._id == this.resp._id ) {
                      header.push(this.compareList[i].name+' (Current)');
                  } else {
                      header.push(this.compareList[i].name);
                  }
              }
              if( !hasCurrent ) {
                  header.push('Current');
              }
              this.dataArray.splice(0,0,header);
          } else {
              this.dataArray.splice(0,0,['Wavelength','Value']);
          }


          this.filterByWavelength();
          this.loading = false;
      },

      addToDataArray : function(spectra, wavelengthHash, i) {
          var cWaves = [], pt;
          for( var j = 0; j < spectra.datapoints.length; j++ ) {
              pt = spectra.datapoints[j];

              if( this.ptRegex1.exec(pt.key) || this.ptRegex2.exec(pt.key) ) {
                  if( wavelengthHash[pt.key] !== undefined ) {
                      wavelengthHash[pt.key].push(parseFloat(pt.value));
                  } else {
                      wavelengthHash[pt.key] = [parseFloat(pt.key)];
                      for( var z = 0; z < i; z++ ) wavelengthHash[pt.key].push(null);
                      wavelengthHash[pt.key].push(parseFloat(pt.value));
                  }
                  cWaves.push(pt.key);
              }
          }

          // add any waves this one is missing
          for( var key in wavelengthHash ) {
              if( cWaves.indexOf(key) > -1 ) continue;
              wavelengthHash[key].push(null);
          }
      },

      setWavelength : function(type, value) {
          this[type+'Wavelength'] = value;
          this.slider.slider('setValue', [this.minWavelength, this.maxWavelength]);
      },

      filterByWavelength : function() {
          var arr;
          if( this.showingStats ) arr = [];
          else arr = [this.dataArray[0]];

          for( var i = 1; i < this.dataArray.length; i++ ) {
              if( this.dataArray[i][0] >= this.minWavelength &&
                  this.dataArray[i][0] <= this.maxWavelength ) {

                  var clone = this.dataArray[i].slice(0);
                  clone[0] = clone[0]+'';
                  arr.push(clone);
              }
          }

          if( this.showingStats ) {
            this.dt = new google.visualization.DataTable();
            this.dt.addColumn('string', 'Wavelength');
            this.dt.addColumn('number', 'Average');
            // A column for custom tooltip content
            this.dt.addColumn({id: 'tooltip', type: 'string', role: 'tooltip','p': {'html': true}});

            this.dt.addColumn('number', 'Min');
            this.dt.addColumn('number', 'Max');


            this.dt.addRows(arr);


          } else {
            this.dt = google.visualization.arrayToDataTable(arr);
          }

          this.redraw();
      },

      redraw : function() {
          if( !this.chart || !this.dt ) return;

          var options = {
              legend : {
                  position : 'none'
              },
              vAxis : {},
              hAxis : {},
              tooltip: {isHtml: true}
          };



          if( this.label && this.label != '' ) {
              options.title = this.label;
          }
          if( this.xlabel && this.xlabel != '' ) {
              options.hAxis.title = this.xlabel;
          }
          if( this.ylabel && this.ylabel != '' ) {
              options.vAxis.title = this.ylabel;
          }

          if( this.packageData['Wavelength Units'] && this.packageData['Wavelength Units'].length === 1  ) {
            options.hAxis.title = 'Wavelength ('+this.packageData['Wavelength Units'][0]+')';
          }


          this.chart.draw(this.dt, options);
      },


      toggleAdvanced : function() {
        $(this.$.advancedPanel).toggle();
      },

      toggleStats : function(e) {
        if( !$(e.currentTarget).prop('checked') ) {
          this.$.spectraSliderRow.style.display = 'block';
          this.$.next.style.display = 'inline-block';
          this.$.previous.style.display = 'inline-block';
          this.$.metadataPanel.className = 'flex';
          this.$.countLabel.style.display = 'inline-block';

          this.showingStats = false;
          this.createTableArray();
          this.updateAttributes();
        } else {
          this.$.spectraSliderRow.style.display = 'none';
          this.$.next.style.display = 'none';
          this.$.previous.style.display = 'none';
          this.$.metadataPanel.className = '';
          this.$.countLabel.style.display = 'none';

          this.updateStats();
        }
      },

      updateStats : function() {
        this.showingStats = true;
        //this.$.attributes.innerHTML = '';

        var filters = '';
        if( this.activeFilter ) {
            filters = '&filters='+encodeURIComponent(JSON.stringify([this.activeFilter]));
        }

        if( this.stats.key === filters ) {
          this.createStatsTableArray();
        } else {
          this.stats.key = filters;

          this.$.loadingPanel.style.display = 'inline-block';
          this.$.loadingPanel.innerHTML = 'Calculating...';

          var url = '/spectra/stats?package_id='+this.package+filters;
          $.get(url, function(resp){
            this.stats.value = resp;

            var keys = Object.keys(resp);
            if( keys.length > 0 ) {
              this.totalSpectra = parseInt(resp[keys[0]].count);
              this.updateIndexSelector();
            }

            this.createStatsTableArray();
            this.$.loadingPanel.style.display = 'none';
          }.bind(this));

          this.$.restLink.setAttribute('href', window.location.origin+url);
        }
      },

      createStatsTableArray : function() {
        this.dataArray = [];
        var v, f, k, k2;

        for( k in this.stats.value ) {
            v = this.stats.value[k];

            if( this.ptRegex1.exec(k) || this.ptRegex2.exec(k) ) {

              f = '<div style="padding:5px">';
              for( k2 in v ) f += '<b>'+k2+'</b>: '+v[k2].toFixed(6)+'<br />';
              f += '</div>';

              this.dataArray.push([parseFloat(k), v.avg, f, v.min, v.max]);
            }
        }

        this.dataArray.sort(function(a, b){
            if( a[0] < b[0] ) return -1;
            if( a[0] > b[0] ) return 1;
            return 0;
        });

        this.filterByWavelength();
      },

      onMouseOutChart : function() {
        this.$.hoverInfo.innerHTML = '';
      },

      onMouseOverChart : function(e) {
        if( !this.showingStats ) return;
        if( e.row === undefined ) return;

        var k = this.dataArray[e.row][2];
        this.$.hoverInfo.innerHTML = k.replace(/\n/g, ', ').replace(/, $/, '');
      }
    });
  </script>
</dom-module>
