<dom-module id="home-stats">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <div class="jumbotron" style="margin-bottom: 0; text-align:center;background-color: white; padding: 100px 0 50px 0;border-bottom: 1px solid #eee">
      <p>Welcome to the EcoSIS Spectral Library<span class="sandbox" style="font-weight:bold">&nbsp;Sandbox</span>, a useful tool for finding spectral data. <br />
        <p id="count" class="tlt" data-in-effect="fadeInDown" data-in-shuffle="true"></p>
      </p>

      <p><a href="/#search" class="btn btn-primary btn-lg" role="button"><i class="fa fa-search"></i>  Find Spectra</a></p>
      
        <div style="margin-top:30px; text-align:center; padding: 25px 5%">
          Data maintainers, add or edit spectra <a id="mainainerLink" href="http://data.ecosis.org">here.</a>
        </div>
    
    </div>

    <div style="background: #f8f8f8; padding: 25px 0">
      <div class="container">
        <div class="row">
          <div class="col-sm-4">
            <h4>Top Organizations</h4>
            <div id="organization"></div>
          </div>
          <div class="col-sm-4">
            <h4>Top Keywords</h4>
            <div id="Keywords"></div>
          </div>
          <div class="col-sm-4">
            <h4>Top Themes</h4>
            <div id="Theme"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="border-bottom:1px solid #eee;margin-bottom: 30px"></div>

    <div class="container">
      <h4>Recently Added</h4>
      <div id="added"></div>
    </div>
    
    <div style="border-top: 1px solid #eee; padding: 25px 0; background: #f8f8f8">
      <div class="container">
        <div class="col-md-4">
          <h5>Contribute!</h5>
          <div>
            Want to contribute?  Visit <a href="http://data.ecosis.org">http://data.ecosis.org</a>.
          </div>
        </div>
        <div class="col-md-4">
          <h5>Need Help?</h5>
          <div>
            Visit the <a href="http://tutorial.ecosis.org" target="_blank">EcoSIS Tutorials</a>.
          </div>
        </div>
        <div class="col-md-4">
          <h5>Contact</h5>
          <div>
            <a href="mailto:info@ecosis.org">info@ecosis.org</a>: General EcoSIS questions and program information. <br />
            <a href="mailto:help@ecosis.org">help@ecosis.org</a>: Technical help questions for EcoSIS applications and tools.
          </div>
        </div>
      </div>
    </div>


  </template>
  <script>
    Polymer({
      is: 'home-stats',

      ready : function() {
        this.stats = {};
        this.top = ['ecosis.organization', 'Keywords', 'Theme'];
        $.get('/stats/home', this.onStatsLoad.bind(this));
      },

      onStatsLoad : function(stats) {
        this.stats = stats;

        this.$.count.innerHTML = stats.spectraCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")+' spectra and counting.';

        this.top.forEach(function(filter){
          this.createList(filter);
        }.bind(this));

        var html = '';
        stats.lastAdded.forEach(function(pkg){
          html += '<div class="panel panel-default"><div class="panel-body"><h4><a href="/#result/'+pkg.ecosis.package_id+'">'+pkg.ecosis.package_title+'</a>';
          html += '<small class="pull-right">Created: '+new Date(pkg.ecosis.created).toLocaleDateString()+'</small></h4>';
          html += '<a href="/'+this.createFilter('ecosis.organization', pkg.ecosis.organization)+'">'+pkg.ecosis.organization+'</a>';
          html += '<div class="help-block">'+pkg.ecosis.description+'</div>';
          if( pkg.Theme ) {
            var themes = pkg.Theme.map(function(t){
              return this.createFilterLink('Theme', t);
            }.bind(this));
            html += '<div>Themes: '+themes.join(', ')+'</div>';
          }
          if( pkg.Keywords ) {
            var keywords = pkg.Keywords.map(function(k){
              return this.createFilterLink('Keywords', k);
            }.bind(this));
            html += '<div>Keywords: '+keywords.join(', ')+'</div>';
          }
          html += '</div></div>';
        }.bind(this));

        this.$.added.innerHTML = html;
      },

      createList : function(filter){
        var html = '<ul class="list-group">';
        var list = this.stats[filter];
        var f, hash;

        list.forEach(function(item){
          html += '<li class="list-group-item">'+
              '<a href="/'+this.createFilter(filter, item.value)+'">'+item.value+'</a> '+
              '<span class="badge">'+item.count+'</span>'+
            '</li>';
        }.bind(this));

        this.$[filter.replace(/.*\./,'')].innerHTML = html+'</ul>';
      },

      createFilterLink : function(key, value) {
        return '<a href="#/"'+this.createFilter(key, value)+'>'+value+'</a>';
      },

      createFilter : function(key, value) {
        var f = {};
        f[key] = value;
        var q = MQE.getDefaultQuery();
        q.filters = [f];
        return MQE.queryToUrlString(q);
      }



    });
  </script>
</dom-module>
