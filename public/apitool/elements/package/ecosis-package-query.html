<dom-module id="ecosis-package-query">
  <style>
    :host {
      display: block;
    }
  </style>

  <template>
    <h4 class="page-header">/package/query</h4>

    <h5>Parameters</h5>

    <div class="form-horizontal">
      <div class="form-group">
        <label for="filtersInput" class="col-lg-2 control-label">filter</label>
        <div class="col-lg-10">
          <ecosis-filter-creator on-filter-update="setFilters"></ecosis-filter-creator>
          <div class="help-block"><a href="http://www.json.org/" target="_blank">JSON</a> array
            containing object filters to apply.  Each object in the array should be a MongoDB
            <a href="http://docs.mongodb.org/manual/tutorial/query-documents/" target="_blank">query object.</a>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">text</label>
        <div class="col-lg-10">
          <input type="text" class="form-control" on-keyup="onTextKeyUp"/>
          <div class="help-block">The free text query</div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">start</label>
        <div class="col-lg-10">
          <input type="number" class="form-control" value="0" on-change="setRange" id="start" />
          <div class="help-block">The start index of the response</div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">stop</label>
        <div class="col-lg-10">
          <input type="number" class="form-control" value="6" on-change="setRange" id="end" />
          <div class="help-block">The stop index of the response</div>
        </div>
      </div>
    </div>

    <h5>Preview</h5>
    <div id="preview"></div>
    <div id="previewEscaped"></div>

    <ecosis-query-preview id="queryPreview"></ecosis-query-preview>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-package-query',

    ready : function() {
      this.host = 'http://localhost:3003';
      this.textTimer = -1;

      this.query = {
        filters : [],
        text : '',
        start : 0,
        stop : 6,
      };

      this.updatePreview();
    },

    updatePreview : function() {
      var params = '?text='+this.query.text+'&filters='+JSON.stringify(this.query.filters)+'&start='+this.query.start+'&stop='+this.query.stop;
      var escaped = '?text='+encodeURIComponent(this.query.text)+'&filters='+encodeURIComponent(JSON.stringify(this.query.filters))+
                    '&start='+encodeURIComponent(this.query.start)+'&stop='+encodeURIComponent(this.query.stop);
      var url = this.host+'/package/query'+params;
      var urlEscaped = this.host+'/package/query'+escaped;

      this.$.preview.innerHTML = '<a href="'+urlEscaped+'" target="_blank">'+url+'</a>';
      this.$.queryPreview.update(urlEscaped);
    },

    setFilters : function(e) {
      if(!this.query) return;

      this.query.filters = e.detail;
      this.updatePreview();
    },

    onTextKeyUp : function(e) {
      this.query.text = e.currentTarget.value;

      if( this.textTimer != -1 ) clearTimeout(this.textTimer);
      this.textTimer = setTimeout(function(){
        this.textTimer = -1;
        this.updatePreview();
      }.bind(this), 200);
    },

    setRange : function() {
      this.query.start = this.$.start.value;
      this.query.stop = this.$.stop.value;
      this.updatePreview();
    }

  });
</script>
