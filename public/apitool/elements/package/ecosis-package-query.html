<dom-module id="ecosis-package-query">
  <style>
    :host {
      display: block;
    }
    #response {
      max-height: 600px;
      overflow: auto;
    }
  </style>

  <template>
    <h4 class="page-header">/package/query</h4>

    <h5>Parameters</h5>

    <div class="form-horizontal">
      <div class="form-group">
        <label for="filtersInput" class="col-lg-2 control-label">filter</label>
        <div class="col-lg-10">
          <ecosis-filter-creator on-filter-update="setFilters"></ecosis-filter-creator>
          <div class="help-block">JSON object containing array of filters to apply</div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">text</label>
        <div class="col-lg-10">
          <input type="text" class="form-control" />
          <div class="help-block">The free text query</div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">start</label>
        <div class="col-lg-10">
          <input type="number" class="form-control" value="0" />
          <div class="help-block">The start index of the response</div>
        </div>
      </div>

      <div class="form-group">
        <label for="textInput" class="col-lg-2 control-label">stop</label>
        <div class="col-lg-10">
          <input type="number" class="form-control" value="6" />
          <div class="help-block">The stop index of the response</div>
        </div>
      </div>
    </div>

    <h5>Preview</h5>
    <div id="preview"></div>
    <div id="previewEscaped"></div>

    <div id="response"></div>

  </template>
</dom-module>

<script>
  Polymer({
    is : 'ecosis-package-query',

    ready : function() {
      this.host = 'http://localhost:3003';

      this.query = {
        filters : [],
        text : '',
        start : 0,
        stop : 6,
      };

      this.updatePreview();
    },

    updatePreview : function() {
      var params = '?text='+this.query.text+'&filters='+JSON.stringify(this.query.filters)+'&start='+this.query.start+'&stop='+this.query.stop;
      var escaped = '?text='+encodeURIComponent(this.query.text)+'&filters='+encodeURIComponent(JSON.stringify(this.query.filters))+
                    '&start='+encodeURIComponent(this.query.start)+'&stop='+encodeURIComponent(this.query.stop);
      var url = this.host+'/package/query'+params;
      var urlEscaped = this.host+'/package/query'+escaped;

      this.$.preview.innerHTML = '<a href="'+urlEscaped+'" target="_blank">'+url+'</a>';

      this.$.response.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Loading...';
      $.get(urlEscaped, function(resp){
        var html = JSON.stringify(resp, '  ', '  ')
                        .replace(/ /g, '&nbsp;')
                        .replace(/\n/g, '<br />');

        this.$.response.innerHTML = '<div>'+html+'</div>';
      }.bind(this));
    },

    setFilters : function(e) {
      if(!this.query) return;

      this.query.filters = e.detail;
      this.updatePreview();
    }

  });
</script>
